<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ウクライナ語日本語・日本語ウクライナ語辞典（IndexedDB + Worker）</title>
<style>
:root{--bg:#0b0f14;--fg:#e6e6e6;--muted:#9aa4af;--border:#2a3441;--card:#121821;--accent:#4aa3ff}
html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif}
.wrap{max-width:1100px;margin:20px auto;padding:0 16px}
h1{font-size:20px;margin:0 0 12px}
.toolbar{display:grid;gap:10px}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.seg{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.seg button{border:none;background:transparent;padding:8px 12px;cursor:pointer;color:var(--fg)}
.seg button.active{background:var(--accent);color:#fff}
input[type="text"]{flex:1;min-width:200px;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:var(--bg);color:var(--fg)}
select,button{border:1px solid var(--border);border-radius:12px;padding:8px 10px;background:var(--card);color:var(--fg)}
.pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px}
.muted{color:var(--muted);font-size:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--border);padding:8px}
th{background:var(--card);text-align:left}
tr:nth-child(even){background:rgba(127,127,127,.06)}
.filechk{display:inline-flex;gap:6px;align-items:center;margin-right:8px;margin-bottom:6px}
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;margin-left:8px;background:var(--card)}
.select-buttons{display:inline-flex;gap:6px;margin-left:12px}
.select-buttons button{padding:6px 10px;font-size:12px}
.hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>ウクライナ語日本語・日本語ウクライナ語辞典（IndexedDB + Worker）</h1>

  <div class="toolbar card">
    <div class="row">
      <input id="q" type="text" placeholder="検索語（例：кота / りんご / ニェタ）" />
      <button id="clear">クリア</button>
      <div class="seg" role="tablist" aria-label="検索方向">
        <button id="mode-uk2ja" class="active" data-mode="uk2ja">UK→JA</button>
        <button id="mode-ja2uk" data-mode="ja2uk">JA→UK</button>
        <button id="mode-both" data-mode="both">両方向</button>
      </div>
    </div>

    <div class="row">
      <span class="pill">一致方法:
        <select id="match">
          <option value="contains">部分一致</option>
          <option value="starts" selected>前方一致</option>
          <option value="exact">完全一致</option>
          <option value="regex">正規表現</option>
        </select>
      </span>
      <label class="pill"><input type="checkbox" id="ignoreAccent" checked /> アクセント無視（U+0301）</label>
      <label class="pill"><input type="checkbox" id="caseFold" checked /> 大文字/小文字 無視</label>
      <label class="pill"><input type="checkbox" id="widthFold" checked /> 全角/半角 正規化</label>
      <label class="pill"><input type="checkbox" id="kanaFold" checked /> カタカナ→ひらがな</label>
      <label class="pill"><input type="checkbox" id="rmDakuten" /> 濁点/半濁点 除去</label>
      <label class="pill"><input type="checkbox" id="rmChoon" /> 長音「ー」 除去</label>
      <label class="pill"><input type="checkbox" id="rmPunct" /> 約物・句読点 除去</label>
    </div>

    <div class="row">
      <span class="pill">データセット:
        <span id="fileChecks"></span>
        <span class="select-buttons">
          <button id="selectAll">すべて選択</button>
          <button id="deselectAll">すべて解除</button>
        </span>
        <span class="badge" id="status">準備中…</span>
      </span>
    </div>

    <div class="row muted">
      行数: <span id="rowCount">-</span> ｜ ヒット: <span id="hitCount">0</span> ｜ 表示: <span id="shownCount">0</span>
    </div>
  </div>

  <div class="card" style="margin-top:10px">
    <table>
      <thead>
        <tr><th style="width:38%">ウクライナ語</th><th style="width:38%">日本語</th><th>ソース</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script type="module">
/* =========================================================
   1) datasets-manifest.json を読み込み（.json優先）
      失敗したら静的CSVリストにフォールバック
   2) renderFileChecks() は .json 名で表示し、
      初回は ukr-jap.json と ukr-jap-ad.json のみ ON
   ※ 既存ロジックがある場合でも、下記の関数が上書きされます
   ========================================================= */

const $status = document.getElementById('status');
const $fileChecks = document.getElementById('fileChecks');

function setStatus(t){ if($status) $status.textContent = t; }

// ---- (A) チェック群を描画（JSON優先・初期ON 2つ） ----
function renderFileChecks(files){
  $fileChecks.innerHTML = "";
  const defaults = new Set(["ukr-jap.json","ukr-jap-ad.json"]); // 初期ON

  files.forEach((f,i)=>{
    const id = "f"+i;
    // JSONがあれば JSON を優先し、表示名も JSON の basename
    const filename = (f.json && f.json.trim()) ? f.json : (f.csv || "");
    const label = (f.label && f.label.trim())
                  ? f.label
                  : (filename.split("/").pop() || filename);

    const base = filename.split("/").pop();
    const checked = defaults.has(base);

    const span = document.createElement("span");
    span.className = "filechk";
    span.innerHTML =
      `<input type="checkbox" id="${id}" data-index="${i}" data-filename="${filename}" ${checked?"checked":""}>
       <label for="${id}">${label}</label>`;
    $fileChecks.appendChild(span);
  });

  // 既存ハンドラに接続している前提。最低限のダミーも用意。
  $fileChecks.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("change", handleFileCheckChange);
  });
}

// ---- (B) manifest を読んで UI へ反映。失敗時はCSV固定で代替 ----
async function loadDatasetsAndRender(){
  setStatus("データセット読込中…");
  try{
    const res = await fetch("./datasets-manifest.json", {cache:"no-store"});
    if(!res.ok) throw new Error("manifest http "+res.status);
    const man = await res.json();

    const files = (man.datasets || []).map(d=>{
      const json = d.path || "";
      const csv  = d.source || "";
      const base = (json || csv).split("/").pop();
      return { json, csv, label: base };
    });

    if(!files.length) throw new Error("manifest has 0 datasets");
    renderFileChecks(files);
    setStatus("準備完了");
  }catch(err){
    console.error("[manifest]", err);
    // --- フォールバック（CSV 名を並べるが、json 側があれば json も指定） ---
    const files = [
      { json:"ukr-jap.json",        csv:"ukr-jap.csv",        label:"ukr-jap.json" },
      { json:"ukr-jap-ad.json",     csv:"ukr-jap-ad.csv",     label:"ukr-jap-ad.json" },
      { json:"jap-ukr.json",        csv:"jap-ukr.csv",        label:"jap-ukr.json" },
      { json:"jap-ukr-lat.json",    csv:"jap-ukr-lat.csv",    label:"jap-ukr-lat.json" },
      { json:"jap-ukr-yomi.json",   csv:"jap-ukr-yomi.csv",   label:"jap-ukr-yomi.json" },
      { json:"ukr-acc.json",        csv:"ukr-acc.csv",        label:"ukr-acc.json" },
      { json:"ukr-frek-pro.json",   csv:"ukr-frek-pro.csv",   label:"ukr-frek-pro.json" },
      { json:"ukr-frek-rev.json",   csv:"ukr-frek-rev.csv",   label:"ukr-frek-rev.json" },
      { json:"ukr-henka.json",      csv:"ukr-henka.csv",      label:"ukr-henka.json" },
      { json:"ukr-jap-lat.json",    csv:"ukr-jap-lat.csv",    label:"ukr-jap-lat.json" },
      { json:"ukr-jap-ad-lat.json", csv:"ukr-jap-ad-lat.csv", label:"ukr-jap-ad-lat.json" }
    ];
    renderFileChecks(files);
    setStatus("準備完了（フォールバック）");
  }
}

// ---- (C) 既存処理への薄いブリッジ（最低限のダミー） ----
function handleFileCheckChange(){
  // 既存アプリ側で再ロードする関数があればここで呼ぶ
  if(typeof window.reloadSelectedDatasets === "function"){
    window.reloadSelectedDatasets(getSelectedFilenames());
  }
  // なければ行数だけ更新するダミー
  updateCounts(0,0,0);
}
function getSelectedFilenames(){
  return Array.from($fileChecks.querySelectorAll("input:checked"))
    .map(inp => inp.getAttribute("data-filename"));
}
function updateCounts(rows, hits, shown){
  document.getElementById("rowCount").textContent   = rows;
  document.getElementById("hitCount").textContent   = hits;
  document.getElementById("shownCount").textContent = shown;
}

// 「すべて選択／解除」
document.getElementById("selectAll").addEventListener("click", ()=>{
  $fileChecks.querySelectorAll("input").forEach(i=> i.checked=true);
  handleFileCheckChange();
});
document.getElementById("deselectAll").addEventListener("click", ()=>{
  $fileChecks.querySelectorAll("input").forEach(i=> i.checked=false);
  handleFileCheckChange();
});

// ---- 初期化 ----
document.addEventListener("DOMContentLoaded", ()=>{
  loadDatasetsAndRender();
});

// 入力補助（CSVフォールバック時のタブ検出で .count を使っていた旧コード対策）
function hasTab(txt){ return txt && txt.includes("\t"); }

// クリアボタン（最低限）
document.getElementById("clear").addEventListener("click", ()=>{
  const $q = document.getElementById("q");
  $q.value = "";
  $q.focus();
});
</script>
</body>
</html>
