<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ウクライナ語日本語・日本語ウクライナ語辞典（IndexedDB + Worker）</title>
<style>
body { background:#222; color:#eee; font-family:sans-serif; }
input,select,button { margin:4px; }
#results { margin-top:1em; border-collapse:collapse; width:100%; }
#results th,#results td { border:1px solid #555; padding:4px; }
.pill { display:inline-block; background:#444; padding:4px 8px; border-radius:6px; margin:2px; }
.filechk { margin-right:8px; }
</style>
</head>
<body>
<h2>ウクライナ語日本語・日本語ウクライナ語辞典（IndexedDB + Worker）</h2>

<div>
  <input id="q" placeholder="検索語を入力…" style="width:60%;">
  <button id="clearBtn">クリア</button>
</div>

<div>
  <select id="match">
    <option value="contains">部分一致</option>
    <option value="starts" selected>前方一致</option>
    <option value="exact">完全一致</option>
    <option value="regex">正規表現</option>
  </select>
  <label><input type="checkbox" id="ignoreAccent" checked> アクセント無視 (U+0301)</label>
  <label><input type="checkbox" id="ignoreCase" checked> 大文字/小文字 無視</label>
  <label><input type="checkbox" id="normalizeWidth" checked> 全角/半角 正規化</label>
  <label><input type="checkbox" id="kata2hira" checked> カタカナ→ひらがな</label>
  <label><input type="checkbox" id="ignoreVoicing"> 濁点/半濁点 除去</label>
  <label><input type="checkbox" id="ignoreLongVowel"> 長音「ー」除去</label>
  <label><input type="checkbox" id="ignorePunct"> 約物・句読点 除去</label>
</div>

<div>
  <button id="modeUKJA">UK→JA</button>
  <button id="modeJAUK">JA→UK</button>
  <button id="modeBoth">両方向</button>
</div>

<div class="row">
  <span class="pill">データセット:
    <button id="toggleAll" type="button">全選択/全解除</button>
    <span id="fileChecks"></span>
  </span>
</div>

<div>
  <span id="status"></span>
  <span> 行数: <span id="rowCount">-</span> / ヒット: <span id="hitCount">0</span> / 表示: <span id="dispCount">0</span></span>
</div>

<table id="results">
  <thead>
    <tr><th>ウクライナ語</th><th>日本語</th><th>ソース</th></tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script type="module">
// ====================== 既存コードの設定部分 ======================
const $q=document.getElementById("q");
const $match=document.getElementById("match");
const $fileChecks=document.getElementById("fileChecks");
const $status=document.getElementById("status");
const $rowCount=document.getElementById("rowCount");
const $hitCount=document.getElementById("hitCount");
const $dispCount=document.getElementById("dispCount");
const $tbody=document.getElementById("tbody");

let worker=new Worker("worker.js");
let datasets=[];

// config.jsonを取得
const config=await fetch("config.json").then(r=>r.json());
renderFileChecks(config.files);

// ------------------ データセットチェックボックス生成 ------------------
function renderFileChecks(files){
  $fileChecks.innerHTML="";
  files.forEach((f,i)=>{
    const id="f"+i;
    const label=f.label||(f.json||f.csv);
    // ★初期状態：ukr-jap.csvのみON
    const checked=(f.csv==="ukr-jap.csv");
    const span=document.createElement("span");
    span.className="filechk";
    span.innerHTML=`
      <input type="checkbox" id="${id}" data-index="${i}" ${checked?"checked":""}>
      <label for="${id}">${label}</label>
    `;
    $fileChecks.appendChild(span);
  });

  // 個別変更時
  $fileChecks.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("change", async ()=>{ await reloadDatasetsAndSearch(); });
  });

  // 全選択/全解除ボタン
  const $toggle=document.getElementById("toggleAll");
  if($toggle && !$toggle._bound){
    $toggle._bound=true;
    $toggle.addEventListener("click", async ()=>{
      const allOn=isAllChecked();
      setAllChecked(!allOn);
      await reloadDatasetsAndSearch();
    });
  }
}
function isAllChecked(){
  const boxes=$fileChecks.querySelectorAll("input[type=checkbox]");
  return boxes.length>0 && [...boxes].every(b=>b.checked);
}
function setAllChecked(v){
  $fileChecks.querySelectorAll("input[type=checkbox]").forEach(b=>b.checked=v);
}
async function reloadDatasetsAndSearch(){
  $status.textContent="データ再読込…";
  const enabledIdx=enabledFileIndices();
  const rows=await loadDatasets(enabledIdx);
  worker.postMessage({type:"initRows", rows});
  $rowCount.textContent=rows.length.toLocaleString();
  $status.textContent="準備完了";
  doSearch();
}
function enabledFileIndices(){
  return [...$fileChecks.querySelectorAll("input[type=checkbox]")]
         .filter(b=>b.checked)
         .map(b=>parseInt(b.dataset.index));
}

// ------------------ ダミー実装（必要に応じて差し替え） ------------------
async function loadDatasets(indices){
  // 本来はIndexedDBやfetchでロード
  return [];
}
function doSearch(){
  // 本来は検索処理
  $hitCount.textContent="0";
  $dispCount.textContent="0";
}

// クリアボタン
document.getElementById("clearBtn").addEventListener("click",()=>{
  $q.value="";
  doSearch();
});
</script>
</body>
</html>
