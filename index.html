<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ウクライナ語日本語・日本語ウクライナ語辞典（GitHub Pages）</title>
<style>
:root{--bg:#fff;--fg:#111;--muted:#666;--border:#ddd;--card:#fafafa;--accent:#0b73ec}
[data-theme="dark"]{--bg:#0b0f14;--fg:#e6e6e6;--muted:#9aa4af;--border:#2a3441;--card:#121821;--accent:#4aa3ff}
html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif}
.wrap{max-width:1100px;margin:20px auto;padding:0 16px}
h1{font-size:20px;margin:0 0 12px}
.toolbar{display:grid;gap:10px}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.seg{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.seg button{border:none;background:transparent;padding:8px 12px;cursor:pointer;color:var(--fg)}
.seg button.active{background:var(--accent);color:#fff}
input[type="text"]{flex:1;min-width:200px;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:var(--bg);color:var(--fg)}
select,button{border:1px solid var(--border);border-radius:12px;padding:8px 10px;background:var(--card);color:var(--fg)}
.pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px}
.muted{color:var(--muted);font-size:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--border);padding:8px}
th{background:var(--card);text-align:left}
tr:nth-child(even){background:rgba(127,127,127,0.04)}
.spacer{height:8px}.hidden{display:none}.right{margin-left:auto}
.filechk{display:inline-flex;gap:6px;align-items:center;margin-right:8px}
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;margin-right:6px;background:var(--card)}
.footer{margin-top:10px;display:flex;gap:12px;align-items:center}
.select-buttons{display:inline-flex;gap:6px;margin-left:12px}
.select-buttons button{padding:6px 10px;font-size:12px}
</style></head><body>
<div class="wrap" id="app">
<h1>ウクライナ語日本語・日本語ウクライナ語辞典（IndexedDB + Worker）</h1>
<div class="toolbar card">
  <div class="row">
    <input id="q" type="text" placeholder="検索語（例：кота / りんご / ニェタ）"><button id="clear">クリア</button>
    <div class="seg" role="tablist" aria-label="検索方向">
      <button id="mode-uk2ja" class="active" data-mode="uk2ja">UK→JA</button>
      <button id="mode-ja2uk" data-mode="ja2uk">JA→UK</button>
      <button id="mode-both" data-mode="both">両方向</button>
    </div>
    <button id="themeBtn" class="right" title="ダーク/ライト切替">🌓</button>
  </div>
  <div class="row">
    <span class="pill">一致方法:
      <select id="match"><option value="contains">部分一致</option><option value="starts" selected>前方一致</option><option value="exact">完全一致</option><option value="regex">正規表現</option></select>
    </span>
    <label class="pill"><input type="checkbox" id="ignoreAccent" checked> アクセント無視（U+0301）</label>
    <label class="pill"><input type="checkbox" id="caseFold" checked> 大文字/小文字 無視</label>
    <label class="pill"><input type="checkbox" id="widthFold" checked> 全角/半角 正規化</label>
    <label class="pill"><input type="checkbox" id="kanaFold" checked> カタカナ→ひらがな</label>
    <label class="pill"><input type="checkbox" id="rmDakuten"> 濁点/半濁点 除去</label>
    <label class="pill"><input type="checkbox" id="rmChoon"> 長音「ー」 除去</label>
    <label class="pill"><input type="checkbox" id="rmPunct"> 約物・句読点 除去</label>
  </div>
  <div class="row">
    <span class="pill">データセット: <span id="fileChecks"></span>
      <span class="select-buttons">
        <button id="selectAll">すべて選択</button>
        <button id="deselectAll">すべて解除</button>
      </span>
    </span>
  </div>
  <div class="row muted">行数: <span id="rowCount">-</span> ｜ ヒット: <span id="hitCount">0</span> ｜ 表示: <span id="shownCount">0</span> <span class="badge" id="status">準備中…</span></div>
</div>
<div class="spacer"></div>
<div class="card">
  <table id="tbl"><thead><tr><th style="width:38%">ウクライナ語</th><th style="width:38%">日本語</th><th>ソース</th></tr></thead><tbody id="tbody"></tbody></table>
  <div class="footer"><button id="more" class="hidden">次のページ</button><span class="muted" id="footnote"></span></div>
</div>
</div>
<script type="module">
import { idbGet, idbSet } from "./idb.js";
const savedTheme=localStorage.getItem("theme"); if(savedTheme) document.documentElement.setAttribute("data-theme", savedTheme);
document.getElementById("themeBtn").addEventListener("click",()=>{const cur=document.documentElement.getAttribute("data-theme");const next=cur==="dark"?"light":"dark";document.documentElement.setAttribute("data-theme",next);localStorage.setItem("theme",next)});
const $q=document.getElementById("q"),$match=document.getElementById("match"),$ignoreAccent=document.getElementById("ignoreAccent"),$caseFold=document.getElementById("caseFold"),$widthFold=document.getElementById("widthFold"),$kanaFold=document.getElementById("kanaFold"),$rmDakuten=document.getElementById("rmDakuten"),$rmChoon=document.getElementById("rmChoon"),$rmPunct=document.getElementById("rmPunct"),$fileChecks=document.getElementById("fileChecks"),$clear=document.getElementById("clear"),$status=document.getElementById("status"),$rowCount=document.getElementById("rowCount"),$hit=document.getElementById("hitCount"),$shown=document.getElementById("shownCount"),$tbody=document.getElementById("tbody"),$more=document.getElementById("more"),$footnote=document.getElementById("footnote"),$selectAll=document.getElementById("selectAll"),$deselectAll=document.getElementById("deselectAll");
let CFG=null, MAN=null, MODE="uk2ja", PAGE=0, LAST_RESULT=null; const worker=new Worker("worker.js");
worker.onmessage=(e)=>{const{type,payload}=e.data;if(type==="ready"){$status.textContent="準備完了";doSearch()}else if(type==="searchResult"){LAST_RESULT=payload;$hit.textContent=payload.total.toLocaleString();$shown.textContent=Math.min(LAST_RESULT.total,(PAGE+1)*(CFG.page_size||200)).toLocaleString();renderPage(false);$more.classList.toggle("hidden",(PAGE+1)*(CFG.page_size||200)>=LAST_RESULT.total)}else if(type==="progress"){$status.textContent=payload}else if(type==="error"){$status.textContent="エラー: "+payload}};
function debounce(fn,ms=150){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
function enabledFileIndices(){return[...$fileChecks.querySelectorAll("input[type=checkbox]")].filter(c=>c.checked).map(c=>parseInt(c.dataset.index))}
function setMode(m){MODE=m;document.querySelectorAll(".seg button").forEach(b=>b.classList.toggle("active",b.dataset.mode===m));doSearch()}
document.getElementById("mode-uk2ja").onclick=()=>setMode("uk2ja");document.getElementById("mode-ja2uk").onclick=()=>setMode("ja2uk");document.getElementById("mode-both").onclick=()=>setMode("both");
$q.addEventListener("input",debounce(doSearch,120));[$match,$ignoreAccent,$caseFold,$widthFold,$kanaFold,$rmDakuten,$rmChoon,$rmPunct].forEach(el=>el.addEventListener("change",doSearch));$clear.addEventListener("click",()=>$q.value="");$clear.addEventListener("click",()=>{doSearch();$q.focus()});$more.addEventListener("click",()=>{PAGE+=1;requestSearch(true)});
// 全選択/全解除ボタンのイベントハンドラ
$selectAll.addEventListener("click",()=>{$fileChecks.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=true);handleFileCheckChange()});
$deselectAll.addEventListener("click",()=>{$fileChecks.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=false);handleFileCheckChange()});
async function handleFileCheckChange(){$status.textContent="データ再読込…";const enabledIdx=enabledFileIndices();const datasets=await loadDatasets(enabledIdx);worker.postMessage({type:"initRows",rows:datasets.rows});$rowCount.textContent=datasets.rows.length.toLocaleString();$status.textContent="準備完了";doSearch()}
Promise.all([fetch("config.json",{cache:"no-store"}).then(r=>r.json()),fetch("datasets-manifest.json",{cache:"no-store"}).then(r=>r.json()).catch(()=>({datasets:[]}))]).then(async([cfg,man])=>{CFG=cfg;MAN=man;renderFileChecks(CFG.files);const enabledIdx=enabledFileIndices();const datasets=await loadDatasets(enabledIdx);worker.postMessage({type:"initRows",rows:datasets.rows});$rowCount.textContent=datasets.rows.length.toLocaleString()}).catch(err=>{$status.textContent="設定読込エラー: "+err.message});


function renderFileChecks(files){
  $fileChecks.innerHTML = "";
  files.forEach((f,i)=>{
    const id = "f"+i;
    const label = (f.json ? f.json.split("/").pop() :
                  (f.csv ? f.csv.split("/").pop() :
                  (f.label||"")));
    const fnameJson = (f.json||"").split("/").pop();
    const fnameCsv  = (f.csv||"").split("/").pop();
    // 初回は ukr-jap.json と ukr-jap-ad.json の2つだけON（JSONが無ければCSV名で判定）
    const defaults = new Set(["ukr-jap.json","ukr-jap-ad.json","ukr-jap.csv","ukr-jap-ad.csv"]);
    const shouldCheck = defaults.has(fnameJson || fnameCsv);

    const span = document.createElement("span");
    span.className = "filechk";
    span.innerHTML = `<input type="checkbox" id="${id}" data-index="${i}" ${shouldCheck ? "checked" : ""}><label for="${id}">${label}</label>`;
    $fileChecks.appendChild(span);
  });
  // Bind change handler (re-uses existing logic)
  $fileChecks.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("change", handleFileCheckChange);
  });
}
" data-index="${i}" ${shouldCheck ? "checked" : ""}><label for="${id}">${label}</label>`;
    $fileChecks.appendChild(span);
  });
  // Bind change
  $fileChecks.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("change", handleFileCheckChange);
  });
}
" data-index="${i}" ${shouldCheck ? 'checked' : ''}><label for="${id}">${label}</label>`;$fileChecks.appendChild(span)});$fileChecks.querySelectorAll("input").forEach(inp=>{inp.addEventListener("change",handleFileCheckChange)})}
async function loadDatasets(indices){let allRows=[];for(const i of indices){const f=CFG.files[i];const man=(MAN.datasets||[]).find(d=>d.path===f.json);const ver=man?.version||"noversion";const cacheKey=`ds:${f.json}:${ver}`;let rows=await idbGet(cacheKey);if(!rows){let ok=false;if(f.json){try{const arr=await fetch(f.json,{cache:"no-store"}).then(r=>r.ok?r.json():Promise.reject(new Error("JSONなし")));rows=arr;ok=true}catch{}}if(!ok&&f.csv){const txt=await fetch(f.csv,{cache:"no-store"}).then(r=>r.text());const delim = txt.includes("\t") ? "\t" : ",";rows=txt.replace(/\r\n?/g,"\n").split("\n").filter(Boolean).map(line=>{const cols=line.split(delim);while(cols.length<3)cols.push("");const src=cols[f.src_col||0]||"";const dst=cols[f.dst_col||2]||"";const uk = f.direction==="ja2uk"?dst:src;const ja = f.direction==="ja2uk"?src:dst;return {uk,ja,src:(f.label||f.csv)}})}try{await idbSet(cacheKey,rows)}catch{}}allRows=allRows.concat(rows.map(r=>({uk:r.uk||"",ja:r.ja||"",src:r.src||(f.label||"")})))}return{rows:allRows}}
function doSearch(){PAGE=0;requestSearch(false)}
function currentOptions(){return{ignoreAccent:$ignoreAccent.checked,caseFold:$caseFold.checked,widthFold:$widthFold.checked,kanaFold:$kanaFold.checked,rmDakuten:$rmDakuten.checked,rmChoon:$rmChoon.checked,rmPunct:$rmPunct.checked}}
function requestSearch(append){worker.postMessage({type:"search",query:$q.value.trim(),how:$match.value,mode:MODE,opt:currentOptions(),page:PAGE,pageSize:(CFG.page_size||200)})}
function renderPage(append){const rows=LAST_RESULT?LAST_RESULT.rows:[];if(!append)$tbody.innerHTML="";const esc=s=>(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;");rows.forEach(r=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${esc(r.uk)}</td><td>${esc(r.ja)}</td><td>${esc(r.src)}</td>`;$tbody.appendChild(tr)});$footnote.textContent=LAST_RESULT?.note||""}
</script></body></html>