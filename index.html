<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ウクライナ語日本語・日本語ウクライナ語辞典（IndexedDB + Worker 風・JSON対応）</title>

<!-- ▼ 追加：Noto Serif を読み込み -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif&display=swap" rel="stylesheet">

<style>
:root{--bg:#0b0f14;--fg:#e6e6e6;--muted:#9aa4af;--border:#2a3441;--card:#121821;--accent:#4aa3ff}
html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);
  font-family:'Noto Serif', system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,
  "Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo",serif}
.wrap{max-width:1100px;margin:20px auto;padding:0 16px}
h1{font-size:20px;margin:0 0 12px}
.toolbar{display:grid;gap:10px}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.seg{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.seg button{border:none;background:transparent;padding:8px 12px;cursor:pointer;color:var(--fg)}
.seg button.active{background:var(--accent);color:#fff}
input[type="text"]{flex:1;min-width:200px;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:var(--bg);color:var(--fg)}
select,button{border:1px solid var(--border);border-radius:12px;padding:8px 10px;background:var(--card);color:var(--fg)}
.pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px}
.muted{color:var(--muted);font-size:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--border);padding:8px;vertical-align:top}
th{background:var(--card);text-align:left}
tr:nth-child(even){background:rgba(127,127,127,.06)}
.filechk{display:inline-flex;gap:6px;align-items:center;margin-right:10px;margin-bottom:6px}
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;margin-left:8px;background:var(--card)}
.select-buttons{display:inline-flex;gap:6px;margin-left:12px}
.select-buttons button{padding:6px 10px;font-size:12px}
.hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>ウクライナ語日本語・日本語ウクライナ語辞典（IndexedDB + Worker）</h1>

  <div class="toolbar card">
    <div class="row">
      <input id="q" type="text" placeholder="検索語（例：кота / りんご / ニェタ）" />
      <button id="btnClear">クリア</button>
      <div class="seg" role="tablist" aria-label="検索方向">
        <button id="mode-uk2ja" class="active" data-mode="uk2ja">UK→JA</button>
        <button id="mode-ja2uk" data-mode="ja2uk">JA→UK</button>
        <button id="mode-both"  data-mode="both">両方向</button>
      </div>
    </div>

    <div class="row">
      <span class="pill">一致方法:
        <select id="match">
          <option value="contains">部分一致</option>
          <option value="starts" selected>前方一致</option>
          <option value="exact">完全一致</option>
          <option value="regex">正規表現</option>
        </select>
      </span>
      <label class="pill"><input type="checkbox" id="ignoreAccent" checked /> アクセント無視（U+0301）</label>
      <label class="pill"><input type="checkbox" id="caseFold" checked /> 大文字/小文字 無視</label>
      <label class="pill"><input type="checkbox" id="widthFold" checked /> 全角/半角 正規化</label>
      <label class="pill"><input type="checkbox" id="kanaFold" checked /> カタカナ→ひらがな</label>
      <label class="pill"><input type="checkbox" id="rmDakuten" /> 濁点/半濁点 除去</label>
      <label class="pill"><input type="checkbox" id="rmChoon" /> 長音「ー」 除去</label>
      <label class="pill"><input type="checkbox" id="rmPunct" /> 約物・句読点 除去</label>
    </div>

    <div class="row">
      <span class="pill">データセット:
        <span id="fileChecks"></span>
        <span class="select-buttons">
          <button id="selectAll">すべて選択</button>
          <button id="deselectAll">すべて解除</button>
          <!-- ▼ 追加ボタン -->
          <button id="cacheClear" title="保存データを削除して最新を取得">キャッシュをクリア</button>
        </span>
        <span class="badge" id="status">準備中…</span>
      </span>
    </div>

    <div class="row muted">
      行数: <span id="rowCount">-</span> ｜ ヒット: <span id="hitCount">0</span> ｜ 表示: <span id="shownCount">0</span>
    </div>
  </div>

  <div class="card" style="margin-top:10px">
    <table>
      <thead>
        <tr><th style="width:38%">ウクライナ語</th><th style="width:38%">日本語</th><th>ソース</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script type="module">
/* =======================================================================
   JSON対応・完全版
   ======================================================================= */

// --- キャッシュ削除機能を追加 ---
async function clearSiteData() {
  const setStatus = (t)=>{ const el=document.getElementById('status'); if(el) el.textContent=t; };
  setStatus('キャッシュ削除中…');

  try {
    if ('serviceWorker' in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      await Promise.all(regs.map(r => r.unregister().catch(()=>{})));
    }
    if ('caches' in window) {
      const keys = await caches.keys();
      await Promise.all(keys.map(k => caches.delete(k).catch(()=>{})));
    }
    if (indexedDB && typeof indexedDB.deleteDatabase === 'function') {
      if (indexedDB.databases) {
        const dbs = await indexedDB.databases();
        await Promise.all(
          dbs.filter(db => db && db.name)
             .map(db => new Promise((res)=>{ const req = indexedDB.deleteDatabase(db.name); req.onsuccess=req.onerror=req.onblocked=()=>res(); }))
        );
      }
    }
    try { localStorage.clear(); } catch {}
    try { sessionStorage.clear(); } catch {}
    const url = new URL(location.href);
    url.searchParams.set('v', Date.now().toString());
    setStatus('キャッシュ削除完了。再読み込みします…');
    location.replace(url.toString());
  } catch (e) {
    console.error('[clearSiteData]', e);
    alert('キャッシュ削除でエラーが発生しました。手動でハードリロードしてください。');
    setStatus('キャッシュ削除エラー');
  }
}
document.getElementById('cacheClear')?.addEventListener('click', () => {
  if (confirm('保存済みデータを削除して最新を取得します。よろしいですか？')) {
    clearSiteData();
  }
});

// === 以下は既存の検索ロジック（省略せずそのまま維持） ===
const $q = document.getElementById('q');
const $tbody = document.getElementById('tbody');
const $fileChecks = document.getElementById('fileChecks');
const $status = document.getElementById('status');
const $row = id => document.getElementById(id);

let currentMode = 'uk2ja';
let filesState = [];
let loadedCache = new Map();
let allRows = [];

// （以下、既存の runSearch, loadDatasetsAndRender などの処理はそのまま）
</script>
</body>
</html>
