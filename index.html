<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠèªæ—¥æœ¬èªãƒ»æ—¥æœ¬èªã‚¦ã‚¯ãƒ©ã‚¤ãƒŠèªè¾å…¸ï¼ˆGitHub Pagesï¼‰</title>
<style>
:root{--bg:#fff;--fg:#111;--muted:#666;--border:#ddd;--card:#fafafa;--accent:#0b73ec}
[data-theme="dark"]{--bg:#0b0f14;--fg:#e6e6e6;--muted:#9aa4af;--border:#2a3441;--card:#121821;--accent:#4aa3ff}
html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif}
.wrap{max-width:1100px;margin:20px auto;padding:0 16px}
h1{font-size:20px;margin:0 0 12px}
.toolbar{display:grid;gap:10px}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.seg{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.seg button{border:none;background:transparent;padding:8px 12px;cursor:pointer;color:var(--fg)}
.seg button.active{background:var(--accent);color:#fff}
input[type="text"]{flex:1;min-width:200px;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:var(--bg);color:var(--fg)}
select,button{border:1px solid var(--border);border-radius:12px;padding:8px 10px;background:var(--card);color:var(--fg)}
.pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px}
.muted{color:var(--muted);font-size:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--border);padding:8px}
th{background:var(--card);text-align:left}
tr:nth-child(even){background:rgba(127,127,127,0.04)}
.spacer{height:8px}.hidden{display:none}.right{margin-left:auto}
.filechk{display:inline-flex;gap:6px;align-items:center;margin-right:8px}
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;margin-right:6px;background:var(--card)}
.footer{margin-top:10px;display:flex;gap:12px;align-items:center}
.select-buttons{display:inline-flex;gap:6px;margin-left:12px}
.select-buttons button{padding:6px 10px;font-size:12px}
</style></head><body>
<div class="wrap" id="app">
<h1>ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠèªæ—¥æœ¬èªãƒ»æ—¥æœ¬èªã‚¦ã‚¯ãƒ©ã‚¤ãƒŠèªè¾å…¸ï¼ˆIndexedDB + Workerï¼‰</h1>
<div class="toolbar card">
  <div class="row">
    <input id="q" type="text" placeholder="æ¤œç´¢èªï¼ˆä¾‹ï¼šĞºĞ¾Ñ‚Ğ° / ã‚Šã‚“ã” / ãƒ‹ã‚§ã‚¿ï¼‰"><button id="clear">ã‚¯ãƒªã‚¢</button>
    <div class="seg" role="tablist" aria-label="æ¤œç´¢æ–¹å‘">
      <button id="mode-uk2ja" class="active" data-mode="uk2ja">UKâ†’JA</button>
      <button id="mode-ja2uk" data-mode="ja2uk">JAâ†’UK</button>
      <button id="mode-both" data-mode="both">ä¸¡æ–¹å‘</button>
    </div>
    <button id="themeBtn" class="right" title="ãƒ€ãƒ¼ã‚¯/ãƒ©ã‚¤ãƒˆåˆ‡æ›¿">ğŸŒ“</button>
  </div>
  <div class="row">
    <span class="pill">ä¸€è‡´æ–¹æ³•:
      <select id="match"><option value="contains">éƒ¨åˆ†ä¸€è‡´</option><option value="starts" selected>å‰æ–¹ä¸€è‡´</option><option value="exact">å®Œå…¨ä¸€è‡´</option><option value="regex">æ­£è¦è¡¨ç¾</option></select>
    </span>
    <label class="pill"><input type="checkbox" id="ignoreAccent" checked> ã‚¢ã‚¯ã‚»ãƒ³ãƒˆç„¡è¦–ï¼ˆU+0301ï¼‰</label>
    <label class="pill"><input type="checkbox" id="caseFold" checked> å¤§æ–‡å­—/å°æ–‡å­— ç„¡è¦–</label>
    <label class="pill"><input type="checkbox" id="widthFold" checked> å…¨è§’/åŠè§’ æ­£è¦åŒ–</label>
    <label class="pill"><input type="checkbox" id="kanaFold" checked> ã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãª</label>
    <label class="pill"><input type="checkbox" id="rmDakuten"> æ¿ç‚¹/åŠæ¿ç‚¹ é™¤å»</label>
    <label class="pill"><input type="checkbox" id="rmChoon"> é•·éŸ³ã€Œãƒ¼ã€ é™¤å»</label>
    <label class="pill"><input type="checkbox" id="rmPunct"> ç´„ç‰©ãƒ»å¥èª­ç‚¹ é™¤å»</label>
  </div>
  <div class="row">
    <span class="pill">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ: <span id="fileChecks"></span>
      <span class="select-buttons">
        <button id="selectAll">ã™ã¹ã¦é¸æŠ</button>
        <button id="deselectAll">ã™ã¹ã¦è§£é™¤</button>
      </span>
    </span>
  </div>
  <div class="row muted">è¡Œæ•°: <span id="rowCount">-</span> ï½œ ãƒ’ãƒƒãƒˆ: <span id="hitCount">0</span> ï½œ è¡¨ç¤º: <span id="shownCount">0</span> <span class="badge" id="status">æº–å‚™ä¸­â€¦</span></div>
</div>
<div class="spacer"></div>
<div class="card">
  <table id="tbl"><thead><tr><th style="width:38%">ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠèª</th><th style="width:38%">æ—¥æœ¬èª</th><th>ã‚½ãƒ¼ã‚¹</th></tr></thead><tbody id="tbody"></tbody></table>
  <div class="footer"><button id="more" class="hidden">æ¬¡ã®ãƒšãƒ¼ã‚¸</button><span class="muted" id="footnote"></span></div>
</div>
</div>
<script type="module">
import { idbGet, idbSet } from "./idb.js";
const savedTheme=localStorage.getItem("theme"); if(savedTheme) document.documentElement.setAttribute("data-theme", savedTheme);
document.getElementById("themeBtn").addEventListener("click",()=>{const cur=document.documentElement.getAttribute("data-theme");const next=cur==="dark"?"light":"dark";document.documentElement.setAttribute("data-theme",next);localStorage.setItem("theme",next)});
const $q=document.getElementById("q"),$match=document.getElementById("match"),$ignoreAccent=document.getElementById("ignoreAccent"),$caseFold=document.getElementById("caseFold"),$widthFold=document.getElementById("widthFold"),$kanaFold=document.getElementById("kanaFold"),$rmDakuten=document.getElementById("rmDakuten"),$rmChoon=document.getElementById("rmChoon"),$rmPunct=document.getElementById("rmPunct"),$fileChecks=document.getElementById("fileChecks"),$clear=document.getElementById("clear"),$status=document.getElementById("status"),$rowCount=document.getElementById("rowCount"),$hit=document.getElementById("hitCount"),$shown=document.getElementById("shownCount"),$tbody=document.getElementById("tbody"),$more=document.getElementById("more"),$footnote=document.getElementById("footnote"),$selectAll=document.getElementById("selectAll"),$deselectAll=document.getElementById("deselectAll");
let CFG=null, MAN=null, MODE="uk2ja", PAGE=0, LAST_RESULT=null; const worker=new Worker("worker.js");
worker.onmessage=(e)=>{const{type,payload}=e.data;if(type==="ready"){$status.textContent="æº–å‚™å®Œäº†";doSearch()}else if(type==="searchResult"){LAST_RESULT=payload;$hit.textContent=payload.total.toLocaleString();$shown.textContent=Math.min(LAST_RESULT.total,(PAGE+1)*(CFG.page_size||200)).toLocaleString();renderPage(false);$more.classList.toggle("hidden",(PAGE+1)*(CFG.page_size||200)>=LAST_RESULT.total)}else if(type==="progress"){$status.textContent=payload}else if(type==="error"){$status.textContent="ã‚¨ãƒ©ãƒ¼: "+payload}};
function debounce(fn,ms=150){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
function enabledFileIndices(){return[...$fileChecks.querySelectorAll("input[type=checkbox]")].filter(c=>c.checked).map(c=>parseInt(c.dataset.index))}
function setMode(m){MODE=m;document.querySelectorAll(".seg button").forEach(b=>b.classList.toggle("active",b.dataset.mode===m));doSearch()}
document.getElementById("mode-uk2ja").onclick=()=>setMode("uk2ja");document.getElementById("mode-ja2uk").onclick=()=>setMode("ja2uk");document.getElementById("mode-both").onclick=()=>setMode("both");
$q.addEventListener("input",debounce(doSearch,120));[$match,$ignoreAccent,$caseFold,$widthFold,$kanaFold,$rmDakuten,$rmChoon,$rmPunct].forEach(el=>el.addEventListener("change",doSearch));$clear.addEventListener("click",()=>$q.value="");$clear.addEventListener("click",()=>{doSearch();$q.focus()});$more.addEventListener("click",()=>{PAGE+=1;requestSearch(true)});
// å…¨é¸æŠ/å…¨è§£é™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
$selectAll.addEventListener("click",()=>{$fileChecks.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=true);handleFileCheckChange()});
$deselectAll.addEventListener("click",()=>{$fileChecks.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=false);handleFileCheckChange()});
async function handleFileCheckChange(){$status.textContent="ãƒ‡ãƒ¼ã‚¿å†èª­è¾¼â€¦";const enabledIdx=enabledFileIndices();const datasets=await loadDatasets(enabledIdx);worker.postMessage({type:"initRows",rows:datasets.rows});$rowCount.textContent=datasets.rows.length.toLocaleString();$status.textContent="æº–å‚™å®Œäº†";doSearch()}
Promise.all([fetch("config.json",{cache:"no-store"}).then(r=>r.json()),fetch("datasets-manifest.json",{cache:"no-store"}).then(r=>r.json()).catch(()=>({datasets:[]}))]).then(async([cfg,man])=>{CFG=cfg;MAN=man;renderFileChecks(CFG.files);const enabledIdx=enabledFileIndices();const datasets=await loadDatasets(enabledIdx);worker.postMessage({type:"initRows",rows:datasets.rows});$rowCount.textContent=datasets.rows.length.toLocaleString()}).catch(err=>{$status.textContent="è¨­å®šèª­è¾¼ã‚¨ãƒ©ãƒ¼: "+err.message});
function renderFileChecks(files){$fileChecks.innerHTML="";files.forEach((f,i)=>{const id="f"+i;const label=f.label||(f.json||f.csv);
  // åˆæœŸé¸æŠã®åˆ¤å®š: ukr-jap.csvã¨ukr-jap-ad.csvã®ã¿ãƒã‚§ãƒƒã‚¯
  const filename = f.csv || f.json || "";
  const shouldCheck = filename.includes("ukr-jap.csv") || filename.includes("ukr-jap-ad.csv");
  const span=document.createElement("span");span.className="filechk";span.innerHTML=`<input type="checkbox" id="${id}" data-index="${i}" ${shouldCheck ? 'checked' : ''}><label for="${id}">${label}</label>`;$fileChecks.appendChild(span)});$fileChecks.querySelectorAll("input").forEach(inp=>{inp.addEventListener("change",handleFileCheckChange)})}
async function loadDatasets(indices){let allRows=[];for(const i of indices){const f=CFG.files[i];const man=(MAN.datasets||[]).find(d=>d.path===f.json);const ver=man?.version||"noversion";const cacheKey=`ds:${f.json}:${ver}`;let rows=await idbGet(cacheKey);if(!rows){let ok=false;if(f.json){try{const arr=await fetch(f.json,{cache:"no-store"}).then(r=>r.ok?r.json():Promise.reject(new Error("JSONãªã—")));rows=arr;ok=true}catch{}}if(!ok&&f.csv){const txt=await fetch(f.csv,{cache:"no-store"}).then(r=>r.text());const delim = txt.count("\t")>0 ? "\t" : ",";rows=txt.replace(/\r\n?/g,"\n").split("\n").filter(Boolean).map(line=>{const cols=line.split(delim);while(cols.length<3)cols.push("");const src=cols[f.src_col||0]||"";const dst=cols[f.dst_col||2]||"";const uk = f.direction==="ja2uk"?dst:src;const ja = f.direction==="ja2uk"?src:dst;return {uk,ja,src:(f.label||f.csv)}})}try{await idbSet(cacheKey,rows)}catch{}}allRows=allRows.concat(rows.map(r=>({uk:r.uk||"",ja:r.ja||"",src:r.src||(f.label||"")})))}return{rows:allRows}}
function doSearch(){PAGE=0;requestSearch(false)}
function currentOptions(){return{ignoreAccent:$ignoreAccent.checked,caseFold:$caseFold.checked,widthFold:$widthFold.checked,kanaFold:$kanaFold.checked,rmDakuten:$rmDakuten.checked,rmChoon:$rmChoon.checked,rmPunct:$rmPunct.checked}}
function requestSearch(append){worker.postMessage({type:"search",query:$q.value.trim(),how:$match.value,mode:MODE,opt:currentOptions(),page:PAGE,pageSize:(CFG.page_size||200)})}
function renderPage(append){const rows=LAST_RESULT?LAST_RESULT.rows:[];if(!append)$tbody.innerHTML="";const esc=s=>(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;");rows.forEach(r=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${esc(r.uk)}</td><td>${esc(r.ja)}</td><td>${esc(r.src)}</td>`;$tbody.appendChild(tr)});$footnote.textContent=LAST_RESULT?.note||""}
</script></body></html>
